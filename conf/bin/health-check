#!/bin/bash
echo "Running supervisor-based health check..."

# é¢œè‰²è¾“å‡º
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# åŠ è½½ç¯å¢ƒå˜é‡
if [ -f "/code/etc/environment.sh" ]; then
    source /code/etc/environment.sh
fi

echo -e "${GREEN}ğŸ” é€šè¿‡ Supervisor æ£€æŸ¥æœåŠ¡çŠ¶æ€...${NC}"

# å®šä¹‰éœ€è¦æ£€æŸ¥çš„æœåŠ¡
if [ "${DISABLE_REDIS:-false}" = "true" ]; then
    REQUIRED_SERVICES="postgres web celery"
    OPTIONAL_SERVICES="process_monitor"
    echo -e "${GREEN}æ¨¡å¼: PostgreSQL-only${NC}"
else
    REQUIRED_SERVICES="postgres redis web celery"
    OPTIONAL_SERVICES="process_monitor"
    echo -e "${GREEN}æ¨¡å¼: æ ‡å‡†æ¨¡å¼ (ä½¿ç”¨Redis)${NC}"
fi

# æ£€æŸ¥å¿…éœ€çš„æœåŠ¡
failed_services=""
for service in $REQUIRED_SERVICES; do
    status=$(sudo supervisorctl status "$service" 2>/dev/null | awk '{print $2}')
    if [ "$status" = "RUNNING" ]; then
        echo -e "${GREEN}âœ“ $service è¿è¡Œä¸­${NC}"
    else
        echo -e "${RED}âœ— $service æœªè¿è¡Œ (çŠ¶æ€: $status)${NC}"
        failed_services="$failed_services $service"
    fi
done

# æ£€æŸ¥å¯é€‰çš„æœåŠ¡
for service in $OPTIONAL_SERVICES; do
    status=$(sudo supervisorctl status "$service" 2>/dev/null | awk '{print $2}')
    if [ "$status" = "RUNNING" ]; then
        echo -e "${GREEN}âœ“ $service è¿è¡Œä¸­${NC}"
    elif [ "$status" = "EXITED" ] && [ "$service" = "migrate" ]; then
        echo -e "${GREEN}âœ“ $service å·²å®Œæˆ (æ­£å¸¸é€€å‡º)${NC}"
    else
        echo -e "${YELLOW}âš  $service çŠ¶æ€å¼‚å¸¸: $status${NC}"
    fi
done

# å¦‚æœæœ‰å¿…éœ€æœåŠ¡å¤±è´¥ï¼Œé€€å‡ºæ£€æŸ¥
if [ -n "$failed_services" ]; then
    echo -e "${RED}âœ— ä»¥ä¸‹å¿…éœ€æœåŠ¡æœªè¿è¡Œ: $failed_services${NC}"
    exit 1
fi

# é¢å¤–æ£€æŸ¥ï¼šDjangoå¥åº·ç«¯ç‚¹
if curl -f http://localhost:${PORT:-8000}/_health/ > /dev/null 2>&1; then
    echo -e "${GREEN}âœ“ Django å¥åº·æ£€æŸ¥é€šè¿‡${NC}"
else
    echo -e "${RED}âœ— Django å¥åº·æ£€æŸ¥å¤±è´¥${NC}"
    exit 1
fi

# ç³»ç»Ÿèµ„æºæ£€æŸ¥
memory_usage=$(free | grep Mem | awk '{printf "%.1f", $3/$2 * 100.0}')
disk_usage=$(df / | tail -1 | awk '{print $5}' | sed 's/%//')

echo -e "${GREEN}âœ“ å†…å­˜ä½¿ç”¨ç‡: ${memory_usage}%${NC}"
echo -e "${GREEN}âœ“ ç£ç›˜ä½¿ç”¨ç‡: ${disk_usage}%${NC}"

if [ "$disk_usage" -gt 90 ]; then
    echo -e "${YELLOW}âš  ç£ç›˜ä½¿ç”¨ç‡è¿‡é«˜${NC}"
fi

echo -e "${GREEN}ğŸ‰ æ‰€æœ‰å¥åº·æ£€æŸ¥é€šè¿‡ï¼${NC}"